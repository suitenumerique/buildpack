#!/bin/bash

set -o errexit    # always exit on error
set -o pipefail   # don't ignore exit codes when piping output

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Function to output step messages
indent() {
  sed -u 's/^/       /'
}

echo "-----> La Suite NumÃ©rique buildpack"

# Download and extract Node.js buildpack
NODEJS_BUILDPACK_URL="https://github.com/Scalingo/nodejs-buildpack"
NODEJS_BUILDPACK_DIR="$CACHE_DIR/nodejs-buildpack"

if [ ! -d "$NODEJS_BUILDPACK_DIR" ]; then
  echo "-----> Fetching Scalingo Node.js buildpack"
  git clone "$NODEJS_BUILDPACK_URL" "$NODEJS_BUILDPACK_DIR" 2>&1 | indent
fi

# Download and extract Python buildpack
PYTHON_BUILDPACK_URL="https://github.com/Scalingo/python-buildpack"
PYTHON_BUILDPACK_DIR="$CACHE_DIR/python-buildpack"

if [ ! -d "$PYTHON_BUILDPACK_DIR" ]; then
  echo "-----> Fetching Scalingo Python buildpack"
  git clone "$PYTHON_BUILDPACK_URL" "$PYTHON_BUILDPACK_DIR" 2>&1 | indent
fi

# Build frontend first
echo "-----> Building Next.js frontend using Node.js buildpack"
"$NODEJS_BUILDPACK_DIR/bin/compile" "$BUILD_DIR/src/frontend" "$CACHE_DIR/frontend" "$ENV_DIR" 2>&1 | indent

cp -r "$BUILD_DIR/src/frontend/.scalingo" "$BUILD_DIR/.scalingo"

# TODO: configure app name
echo "-----> Moving JS servers out of the frontend workspace"
mv "$BUILD_DIR"/src/frontend/servers "$BUILD_DIR/src/servers"

# Run Python buildpack compile
echo "-----> Running Python buildpack"
"$PYTHON_BUILDPACK_DIR/bin/compile" "$BUILD_DIR/src/backend" "$CACHE_DIR/backend" "$ENV_DIR" 2>&1 | indent

cp -r "$BUILD_DIR/src/backend/.scalingo" "$BUILD_DIR/.scalingo"

# # Run Python buildpack compile
# echo "-----> Use Python backend as new root"
# mv "$BUILD_DIR/src/backend" /tmp/build_backend_tmp && rm -rf $BUILD_DIR && mv /tmp/build_backend_tmp $BUILD_DIR

echo "-----> Build completed" 